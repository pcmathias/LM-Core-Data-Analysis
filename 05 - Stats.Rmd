---
title: "Summarization and statistics in R"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

## Setup

```{r setup}
library(tidyverse) 
library(readxl) 

orders <- read_excel("data/orders_data_set.xlsx")
```

## Summarize

```{r}
orders %>%
  select(order_id, patient_id) %>%
  head(4) %>%
	summarize(order_count = n(),
	          pt_count    = n_distinct(patient_id)) 
```

## Your Turn 1

Add onto the code in the above chunk to calculate:

1) Mean count of orders per patient
2) Mean count of orders per department

*Hints:* 

- Start by adding a new code block here (copy/paste above or CTRL-ALT-I).
- Then copy code from the previous code block and edit to determine the mean number of orders per patient. 
- Next, add code to calculate the mean count of orders per department. 
- Assign the results to new objects, orders_1 and orders_2.
 

## Your Turn 2

Use summarize() to calculate:

1) The date of the first (or minimum) order
2) The median time difference between order_time and result_time

*Hint: Refer to function help for missing data (NA) handling*

```{r, eval=FALSE}
orders %>% 
	summarize(______________)
```


```{r, eval=FALSE}
orders %>%
  mutate(result_interval = ______________) %>%
  summarize(result_interval_med = __________________________)
```

## group_by

```{r}
orders %>% 
  group_by(patient_id, department) %>%
  head(4)
```

## group_by %>% summarize

```{r}
orders %>%
	group_by(patient_id) %>%
	summarize(order_count = n()) %>%
	summarize(pt_order_count_mean = mean(order_count))
```

## Your Turn 4

1) Calculate the median number of orders per patient
2) Calculate the maximum number of TSH orders per patient
3) (*Bonus*) The 5th and 95th percentile of the number of orders per patients

## Your Turn 5
Calculate the mean order count per patient for each department

*Hint: summarize() rolls up a single grouping variable at a time*

```{r, eval=FALSE}
orders %>%
  ________(______________) %>%
  summarize(_______________) %>%
  summarize(_______________________)
```

## Compare two sets of count data

- Is the distribution of the count of orders per patient different in the Internal Medicine and Family Medicine clinics?

## Create sample distributions

```{r}
orders_per_pt_dept <- orders %>%	        
				filter(department %in% c("INTERNAL MEDICINE CLINIC", "FAMILY MEDICINE CLINIC")) %>%
        group_by(department, patient_id) %>%	        
				summarize(order_count = n()) %>%     
				ungroup()
				
head(orders_per_pt_dept)
```

## Visualize the distribution of order counts

```{r}
orders_per_pt_dept %>%
	ggplot() +
	geom_histogram(aes(x = order_count))
```

## Describe the central tendency of the order count

```{r}
orders_per_pt_dept %>% 
		group_by(department) %>% 
		summarize(order_count_median = median(order_count), 
			        order_count_mean = mean(order_count))
```

## Compare the distributions of order counts

```{r}
wilcox.test(order_count ~ department, 
            data        = orders_per_pt_dept, 
            alternative = "two.sided", 
            paired      = FALSE, 
            conf.int    = TRUE)
```

## Your Turn 6

Compare order counts across the nephrology, cardiology, and gastroenterology departments. Are they different?

*Hint: Convert department to a factor using function factor()*

```{r, eval=FALSE}
orders %>%
  mutate(department = factor(department)) %>%      # Convert department from character to factor
  filter(__________________________________) %>%
  group_by(_________________) %>%
  summarize(_______________) %>%
  ungroup() %>%
  kruskal.test(____________ ~ _____________, 
	             data = .)           # `.` refers to the data frame passed via the upstream pipe (%>%)
```


